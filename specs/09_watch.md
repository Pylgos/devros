# ファイル監視 (Watch)

devrosは、ソースコードの変更を自動的に検知し、ビルド・デプロイ・プロセス再起動を実行する開発支援機能を提供します。

## 概要

`devros watch` コマンドは、指定されたディレクトリを監視し、ファイル変更を検知すると以下の処理を自動実行します。

1. **変更検知**: 監視対象パス内のファイル変更をリアルタイムで検知
2. **デバウンス**: 連続する変更をまとめて1回のトリガーとして扱う
3. **自動ビルド**: 変更されたパッケージとその依存パッケージをビルド
4. **自動デプロイ** (オプション): 指定されたターゲットへデプロイ
5. **プロセス通知** (オプション): Supervisorに変更を通知し、関連プロセスを再起動

## 動作フロー

```
ファイル変更検知
    ↓
デバウンス待機
    ↓
変更パッケージの特定
    ↓
ビルド実行
    ↓
デプロイ実行 (--deploy 指定時)
    ↓
Supervisor通知 (デプロイ後)
```

## 監視対象の決定

### 監視パス
`watch_paths` で指定されたディレクトリ配下を再帰的に監視します。通常は `src/` ディレクトリを指定します。

### 除外パターン
`ignore_patterns` で指定されたGlobパターンにマッチするパスは監視対象から除外されます。

- ビルド成果物 (`**/build/**`, `**/install/**`)
- バージョン管理システム (`**/.git/**`)
- エディタ設定 (`**/.vscode/**`, `**/.idea/**`)
- 一時ファイル (`**/*.swp`, `**/*~`)

## デバウンス処理

短時間に連続して発生するファイル変更（エディタの自動保存、一括フォーマットなど）をまとめて処理するため、デバウンス機構を実装します。

- **待機時間**: `debounce_ms` で指定されたミリ秒間、新たな変更がなければ処理を開始
- **デフォルト値**: 500ms (0.5秒)

この値は、レスポンスの速さ（短いほど速い）とCPU負荷（長いほど変更がまとまり効率的）のトレードオフとなります。

## CLI使用例

### 基本的な使用法
```bash
# 監視のみ（ビルドのみ実行）
devros watch

# ビルド後に自動デプロイ
devros watch --deploy local_dev

# 特定のターゲットへ自動デプロイ
devros watch --deploy robot_prod
```

### ワークフロー例
開発中のロボットシステムで、コード変更を保存すると自動的にビルド→リモートデプロイ→プロセス再起動が実行される：

```bash
devros watch --deploy robot_prod
```

この場合の処理フロー：
1. `src/perception_nodes/src/detector.cpp` を編集・保存
2. 500ms後、`perception_nodes` のビルド開始
3. ビルド成功後、`robot_prod` ターゲット（リモートマシン）へrsyncでデプロイ
4. デプロイ完了後、設定された `post_deploy` コマンドが実行される
5. リモート側のSupervisorが `perception_nodes` を `watch_packages` に含むプロセス（例: `perception`）を再起動

## 設定 (devros.toml)

```toml
[watch]
# 監視対象のパス (ワークスペースルートからの相対パス、または絶対パス)
watch_paths = ["src/"]

# 監視から除外する Glob パターン
ignore_patterns = [
    "**/.git/**",
    "**/build/**",
    "**/install/**",
    "**/.vscode/**",
    "**/.idea/**",
    "**/*.swp",
    "**/*~",
]

# 変更検知後のデバウンス時間 (ミリ秒)
# 短期間に連続するファイル変更をまとめて1回のビルドトリガーにするための待機時間
debounce_ms = 500
```

### 設定項目詳細

#### `watch_paths`
- **型**: 文字列配列
- **必須**: いいえ（デフォルト: `["src/"]`）
- **説明**: 監視対象のディレクトリパス。複数指定可能。

#### `ignore_patterns`
- **型**: 文字列配列（Globパターン）
- **必須**: いいえ
- **説明**: 監視対象から除外するファイル・ディレクトリのパターン。
- **パターン構文**:
  - `**`: 任意の深さのディレクトリ
  - `*`: 任意の文字列（パスセパレータを除く）
  - `?`: 任意の1文字

#### `debounce_ms`
- **型**: 整数（ミリ秒）
- **必須**: いいえ（デフォルト: `500`）
- **説明**: ファイル変更検知後、新たな変更がこの時間発生しなければビルドを開始。
- **推奨値**:
  - 高速なフィードバックが必要: `200-300ms`
  - 大規模プロジェクト: `500-1000ms`

## 実装上の考慮事項

### ファイルシステムイベントの監視
- クロスプラットフォームのファイル監視ライブラリ（`notify` crateなど）を使用
- inotify (Linux), FSEvents (macOS) などのOSネイティブ機構を活用

### 変更パッケージの特定
ファイルパスからパッケージを逆引きする必要があります：
1. 変更されたファイルの絶対パスを取得
2. ワークスペース内のパッケージマニフェスト位置と照合
3. 該当するパッケージを特定

### エラーハンドリング
- **ビルド失敗**: エラーを表示し、監視を継続（次の変更を待機）
- **デプロイ失敗**: エラーを表示し、監視を継続
- **ファイルシステムエラー**: 監視できない状態になった場合は終了

### パフォーマンス
- 大量のファイル変更（git checkout等）に対する最適化
- 除外パターンを効率的に適用し、不要なイベント処理を削減
