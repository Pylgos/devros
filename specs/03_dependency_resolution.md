# 依存関係解決 (Dependency Resolution)

devrosは、ワークスペース内のパッケージを探索し、それらの依存関係を解析して、正しいビルド順序（トポロジカルソート順）を決定します。

## 1. パッケージ探索 (Package Discovery)

### 探索ロジック
ワークスペースのルート（または指定されたパス）から再帰的にディレクトリを探索し、パッケージ定義ファイル（主に `package.xml`）を探します。

### 除外ルール (Ignore Rules)
以下の条件に一致するディレクトリは、探索から除外され、そのサブディレクトリも探索されません。

1.  **マーカーファイル**:
    - `COLCON_IGNORE`
    - `AMENT_IGNORE`
    - `CATKIN_IGNORE`
    これらのファイルが存在するディレクトリは無視されます。

2.  **隠しディレクトリ**:
    - `.` で始まるディレクトリ（例: `.git`, `.vscode`）はデフォルトで無視されます。

3.  **特定のディレクトリ**:
    - `build`, `install`, `log` など、devrosが出力先として使用するディレクトリは無視されるべきです。

## 2. パッケージ解析 (Package Parsing)

### package.xml
ROS 2パッケージの標準的な定義ファイルです。devrosは `package.xml` をパースし、以下の情報を抽出します。

- **パッケージ名 (`name`)**: パッケージの一意な識別子。
- **バージョン (`version`)**: パッケージのバージョン。
- **ビルドタイプ (`export/build_type`)**:
    - `ament_cmake`
    - `ament_python`
    - `cmake`
    - その他
- **依存関係**:
    - `<build_depend>`: ビルド時に必要なパッケージ。
    - `<buildtool_depend>`: ビルドツールとして必要なパッケージ。
    - `<build_export_depend>`: このパッケージに依存する他のパッケージがビルドする際に必要なパッケージ。
    - `<exec_depend>`: 実行時に必要なパッケージ（ビルド順序には影響しない場合が多いが、テスト実行時には重要）。
    - `<test_depend>`: テスト時に必要なパッケージ。
    - `<depend>`: ビルド、実行、テストすべてに共通する依存関係。

### 条件付き依存 (Conditions)
`condition` 属性（例: `condition="$ROS_PYTHON_VERSION == 2"`）が含まれる場合、環境変数に基づいて評価を行う必要があります。

## 3. 依存関係グラフ (Dependency Graph)

### グラフ構築
抽出されたパッケージと依存関係情報から、有向グラフ（DAG）を構築します。

- **ノード**: パッケージ
- **エッジ**: 依存関係（パッケージAがパッケージBに依存する場合、B -> A または A -> B のエッジを作成。ビルド順序としては「依存先 -> 依存元」の順）

### トポロジカルソート
グラフをトポロジカルソートし、ビルド順序を決定します。
- 循環依存（Circular Dependency）が検出された場合は、エラーとして報告し、ビルドを中止します。
- 独立したサブグラフが存在する場合、それらは並列にビルド可能です。
